plugins {
    id 'java'
}

def GHIDRA_INSTALL_DIR = System.getenv('GHIDRA_INSTALL_DIR')

repositories {
    mavenCentral()
    flatDir {
        dirs "$GHIDRA_INSTALL_DIR/Ghidra/Framework/Generic/lib"
        dirs "$GHIDRA_INSTALL_DIR/Ghidra/Framework/SoftwareModeling/lib"
        dirs "$GHIDRA_INSTALL_DIR/Ghidra/Framework/Utility/lib"
        dirs "$GHIDRA_INSTALL_DIR/Ghidra/Framework/Docking/lib"
        dirs "$GHIDRA_INSTALL_DIR/Ghidra/Framework/Project/lib"
        dirs "$GHIDRA_INSTALL_DIR/Ghidra/Framework/Gui/lib"
        dirs "$GHIDRA_INSTALL_DIR/Ghidra/Framework/Help/lib"
        dirs "$GHIDRA_INSTALL_DIR/Ghidra/Features/Decompiler/lib"
        dirs "$GHIDRA_INSTALL_DIR/Ghidra/Features/Base/lib"
    }
}

// Configuration for bundled dependencies (only external libs, not Ghidra)
configurations {
    bundled
}

dependencies {
    // Ghidra dependencies - compileOnly so they're NOT bundled in the JAR
    compileOnly name: 'Generic', version: ''
    compileOnly name: 'SoftwareModeling', version: ''
    compileOnly name: 'Decompiler', version: ''
    compileOnly name: 'Base', version: ''
    compileOnly name: 'Utility', version: ''
    compileOnly name: 'Docking', version: ''
    compileOnly name: 'Project', version: ''
    compileOnly name: 'Gui', version: ''
    compileOnly name: 'Help', version: ''
    
    // HTTP client for API calls - these get bundled
    implementation 'com.squareup.okhttp3:okhttp:4.12.0'
    implementation 'com.fasterxml.jackson.core:jackson-core:2.15.2'
    implementation 'com.fasterxml.jackson.core:jackson-databind:2.15.2'
    implementation 'com.fasterxml.jackson.core:jackson-annotations:2.15.2'
    
    bundled 'com.squareup.okhttp3:okhttp:4.12.0'
    bundled 'com.fasterxml.jackson.core:jackson-core:2.15.2'
    bundled 'com.fasterxml.jackson.core:jackson-databind:2.15.2'
    bundled 'com.fasterxml.jackson.core:jackson-annotations:2.15.2'
}

sourceCompatibility = '11'
targetCompatibility = '11'

compileJava {
    options.compilerArgs += ['-Xlint:unchecked', '-Xlint:deprecation']
}

jar {
    baseName = 'GhidraGPT'
    version = '1.2.1'
    
    // Only bundle external dependencies, NOT Ghidra JARs
    from {
        configurations.bundled.collect { it.isDirectory() ? it : zipTree(it) }
    }
    
    duplicatesStrategy = DuplicatesStrategy.EXCLUDE
    
    manifest {
        attributes(
            'Implementation-Title': 'GhidraGPT Plugin',
            'Implementation-Version': version,
            'Implementation-Vendor': 'GhidraGPT'
        )
    }
}

task zipPlugin(type: Zip) {
    baseName = 'GhidraGPT'
    version = '1.2.1'
    extension = 'zip'
    
    // Create proper Ghidra extension structure
    into('GhidraGPT') {
        // Plugin JAR goes in lib directory
        into('lib') {
            from jar.archivePath
        }
        
        // Extension metadata files
        from 'extension.properties'
        from 'Module.manifest'
        
        // Data files
        from('data') {
            into 'data'
        }
        
        // Ghidra scripts directory
        from('ghidra_scripts') {
            into 'ghidra_scripts'
        }
    }
    
    destinationDir = file("$buildDir/distributions")
}

build.dependsOn zipPlugin

// Clean task
clean {
    delete 'build'
}
